# CAN协议梳理附Linux通信实例

CAN(Controller Area Network)也采用串行通信的思想；一种双向两线制差分信号的半双工总线协议，ISO CAN协议标准设计OSI模型的物理层，数据链路层

## 物理层

| 协议项         | 协议内容                               |
| -------------- | -------------------------------------- |
| 通信模式       | 半双工                                 |
| 连接线电气特性 | 两根线CAN_High，CAN_Low                |
| 主从模式       | 多主多从，设备既可以为主机也可以为从机 |

ISO标准化的CAN协议主要有ISO11519（低速CAN）和ISO11898（高速CAN）这两项协议在物理层就有着差别，下为具体介绍：

| 协议         | ISO11898                                                     | ISO11519                                                     |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 通信速度     | 最高1Mbps                                                    | 最高125Kbps                                                  |
| 总线最大长度 | 40m/1Mbps                                                    | 1KM/40Kbps                                                   |
| 连接单元数   | 最大30                                                       | 最大20                                                       |
| 电位         | CANhigh：隐性2v/2.5V/3V；显性：2.75V/3.5V/4.5V               | CANhigh：隐性1.6v/1.75V/1.9V；显性：4V/5V                    |
|              | CANlow：隐性：2V/2.5V/3V；显性：0.5V/1.5V/2.25V              | CANlow：隐性：3.1V/3.25V/3.4V；显性：0.0V/1.0V/1.15V         |
|              | 电位差（H-L）-0.5/0/0.05；2.0/3.0                            | 电位差：-0.3/-1.5/-；0.3/3.0/-                               |
| 电气连接     | 双绞线；阻抗120Ω/总线电阻率80mΩ/m，总线延迟时间5ns/m，终端电阻：120Ω（min85Ω，max130Ω） | 双绞线；阻抗120Ω/总线电阻率90mΩ/m，总线延迟时间5ns/m，终端电阻：2.2KΩ（min2.09KΩ，max2.31KΩ） |

高速CAN与低速CAN又在连线结构上有着区别；

ISO11898高速CAN：

[![pC5yKOK.png](https://s1.ax1x.com/2023/07/15/pC5yKOK.png)](https://imgse.com/i/pC5yKOK)

由上图可知差分信号隐性时逻辑值为‘1’，差分信号显性时逻辑值为‘0’，总线两端接12欧姆电阻防止回波，总线结构为闭环总线。

ISO11519低速CAN：

[![pC5ylwD.png](https://s1.ax1x.com/2023/07/15/pC5ylwD.png)](https://imgse.com/i/pC5ylwD)

由上图可知同样是差分信号隐性时逻辑值为‘1’，差分信号显性时逻辑值为‘0’，总线上H和L都接2.2Kw电阻，总线结构为开环总线。

## 数据链路层

### 帧格式

CAN网络为多主多从模式，在数据链路层有五种帧组成：

| 帧类型 | 帧用途                                           |
| ------ | ------------------------------------------------ |
| 数据帧 | 用于发送单元向接收单元传送数据的帧。             |
| 遥控帧 | 用于接受单元向具有相同ID的发送单元请求数据的帧。 |
| 错误帧 | 用于当检测出错误时向其他单元通知错误的帧。       |
| 过载帧 | 用于接收单元通知其尚未做好接收准备的帧。         |
| 帧间隔 | 用于将数据真及遥控帧与前面的真分离开来的帧。     |

#### 数据帧

数据帧分为标准格式和扩展格式，主要区别在于ID位数，数据段都是0~8Byte（即0~64bit，而之后会介绍BOSCH的另一种CAN标准，CANFD，数据段将会有64Byte）

[![pC5cYsP.png](https://s1.ax1x.com/2023/07/15/pC5cYsP.png)](https://imgse.com/i/pC5cYsP)

由上图所示，其主要区别在于仲裁段标准格式只有11bitID而扩展模式有29bitID。

#### 控制帧

控制帧同样分为标准格式和扩展格式，区别仍为仲裁段ID长度。

[![pC5WkTK.png](https://s1.ax1x.com/2023/07/15/pC5WkTK.png)](https://imgse.com/i/pC5WkTK)

### 仲裁机制

因为总线上会连多个设备，但只有一条信道，这时就需要仲裁决定哪一帧优先级更高，可以继续发送

#### 不同ID优先级确定：

在总线空闲时，最先发送信息的单元获得发送权。

多个单元同时发送时，连续输出显性电平最多的单元可以继续发送。

[![pC54B7t.png](https://s1.ax1x.com/2023/07/15/pC54B7t.png)](https://imgse.com/i/pC54B7t)

#### 相同ID，数据帧遥控帧优先级确定：

数据帧比遥控帧优先级更高。

具有相同ID的数据帧和遥控帧在总线上竞争时，仲裁段的最后以为RTR为显性位的数据帧具有优先权可继续发送。

[![pC54H9U.png](https://s1.ax1x.com/2023/07/15/pC54H9U.png)](https://imgse.com/i/pC54H9U)

#### 标准格式与扩展格式优先级确定：

标准格式ID比扩展ID具有更高的优先级。

标准格式的RTR位为显性，相比扩展格式的SRR具有更高优先级。

[![pC55p4K.png](https://s1.ax1x.com/2023/07/15/pC55p4K.png)](https://imgse.com/i/pC55p4K)

### 错误检测

各单元始终处于以下三种状态之一：

#### 1. 主动错误状态（error active）

主动错误状态时可以正常参加总线通信的状态。注意：这是正常状态

处于主动错误状态的单元检出错误时，输出主动错误标志。

#### 2. 被动错误状态（error passive）

#### 3. 总线关闭态（sleeping）
